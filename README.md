# PCFG Utilities

PCFG Utilities is a Python package providing tools for analysis of **Probabilistic Context-Free Grammars (PCFGs)**, including characteristic matrices, derivational entropy, expected yields, grammar information metrics, and conversion from dependency graphs to context-free derivation trees.

---

## Features

- **Characteristic Matrix**: Compute the expected number of direct nonterminal expansions.
- **SITE (Smoothed Induced Treebank Entropy)**: Estimate the symbolic entropy from a collection of NLTK Trees.
- **Derivational Entropy**: Calculate per-nonterminal entropy using PCFG rule probabilities.
- **Mean Terminal Yield**: Compute the expected number of terminals generated by each nonterminal.
- **Dependency-to-Phrase Structure Tree Conversion**: Convert NLTK dependency graphs into phrase-structure trees for use in PCFGs.
- **Simple integration with NLTK grammars and trees**

---

## Requirements

- [nltk](https://www.nltk.org/)
- numpy
- [entropy_estimators](https://github.com/fermosc24/entropy-estimators) (must be installed manually, see below)

---

## Installation

### 1. Install Required Dependency

Before installing this package, install `entropy_estimators` from GitHub:

```bash
pip install git+https://github.com/fermosc24/entropy-estimators.git
```

### 2. Install pcfg_utilities

Clone this repository and install with pip:

```bash
git clone https://github.com/fermosc24/pcfg-utilities.git
cd pcfg-utilities
pip install .
```

---

## Usage

### **Characteristic Matrix**

```python
from pcfg_utilities.pcfg_utilities import characteristic_matrix
from nltk.grammar import PCFG

grammar = PCFG.fromstring("""
   S -> NP VP [1.0]
   NP -> 'John' [0.5] | 'Mary' [0.5]
   VP -> V NP [1.0]
   V -> 'sees' [1.0]
""")

M, nonterminals = characteristic_matrix(grammar)
print("Characteristic Matrix:\n", M)
print("Nonterminals:", nonterminals)
```

---

### **SITE (Smoothed Induced Treebank Entropy)**

```python
from pcfg_utilities.pcfg_utilities import SITE, sample_n_trees

trees = sample_n_trees(grammar, 100)
site = SITE(trees, method="MLE")
for nt, value in site.items():
    print(f"{nt}: {value:.3f}")
```

- **Parameters**:
  - `trees`: A sequence of nltk tree objects.
  - `method`: See `entropy_estimators` for full list
  
		* `'CWJ'`: Smoothed using the method of Chao, Wang, & Jost (2013), as in Moscoso del Prado (2017, 2025). Default (and most accurate) method.
		* `'CAE'`: Smoothed using Chao & Shen (2003) Coverage-Adjusted Estimator, as in Moscoso del Prado (2014).
		* `'MLE'`: Maximum likelihood estimation (i.e., without any smoothing)


---

### **Derivational Entropy**

```python
from pcfg_utilities.pcfg_utilities import derivational_entropy

entropy = derivational_entropy(grammar)
for nt, value in entropy.items():
    print(f"{nt}: {value:.3f}")
```

---

### **Mean Terminal Yield Length**

```python
from pcfg_utilities.pcfg_utilities import mean_length

lengths = mean_length(grammar)
for nt, value in lengths.items():
    print(f"{nt}: {value:.3f}")
```

---

### **Convert Dependency Graph to Derivation Tree**

```python
from pcfg_utilities.pcfg_utilities import dependency_to_derivation_tree
conll_data = """
1   The     the     DET     DT  _   4   det _   _
2   quick   quick   ADJ     JJ  _   4   amod    _   _
3   brown   brown   ADJ     JJ  _   4   amod    _   _
4   fox     fox     NOUN    NN  _   5   nsubj   _   _
5   jumps   jump    VERB    VBZ _   0   root    _   _
6   over    over    ADP     IN  _   5   case    _   _
7   the     the     DET     DT  _   9   det _   _
8   lazy    lazy    ADJ     JJ  _   9   amod    _   _
9   dog     dog     NOUN    NN  _   5   obl _   _
10  .       .       PUNCT   .   _   5   punct   _   _
"""
dep_graph = DependencyGraph(conll_data)

tree = dependency_to_derivation_tree(dep_graph,leaf='word',dep=True)
print(tree.pretty_print())
```

- **Parameters**:
  - `dep_graph`: An `nltk.parse.DependencyGraph` instance.
  - `leaf`: `'word'` or `'POS'`. Chooses whether the leaves are terminal words or POS tags.
  - `dep`: If `True`, includes dependency label nodes. If `False`, flattens the tree without relabeling with dependency types.

---

## Function Reference

### characteristic_matrix(pcfg)
> Computes the characteristic matrix for a given PCFG.

### SITE(trees, method="CWJ")
> Estimates **Smoothed Induced Treebank Entropy (SITE)** from a collection of NLTK trees.

### derivational_entropy(pcfg)
> Computes the expected derivational entropy for each nonterminal of a PCFG.

### mean_length(pcfg)
> Computes the mean terminal yield length for each nonterminal.

### sample_n_trees(pcfg, n)
> Randomly samples `n` trees from a PCFG.

### dependency_to_derivation_tree(dep_graph, leaf='word', dep=True)
> Converts an NLTK dependency graph into a context-free derivation tree.
> 
> - `leaf`: `'word'` or `'POS'` — type of leaves.
> - `dep`: Whether to include dependency labels (`True`) or collapse them (`False`).

---

## Testing

```bash
python -m unittest discover tests
```

---

## Contributing

Contributions are welcome! Please open an issue or pull request.

---

## License

MIT License

---

## Citation

If you use this package, please cite:

Moscoso del Prado Martín, Fermín (2025) Measuring Grammatical Diversity from Small Corpora: Derivational Entropy Rates, Mean Length of Utterances, and Annotation Invariance. *Computational Linguistics*, 2025. [https://doi.org/10.1162/coli.a.15](https://doi.org/10.1162/coli.a.15)

---

## References

- Chao, A., & Shen, T.-J. (2003). Non-parametric estimation of Shannon's index of diversity when there are unseen species in the sample. *Environmental and Ecological Statistics*, **10**, 429–443. [https://doi.org/10.1023/A:1026096204727](https://doi.org/10.1023/A:1026096204727)

- Chao, A., Wang, Y. T., & Jost, L. (2013). Entropy and the species accumulation curve: a novel entropy estimator via discovery rates of new species. *Methods in Ecology and Evolution*, **4**, 1091–1100. [https://doi.org/10.1111/2041-210X.12108](https://doi.org/10.1111/2041-210X.12108)

- Moscoso del Prado Martín, F. (2014). Grammatical change begins within the word: Causal modeling of the co-evolution of Icelandic morphology and syntax. *In* P. Bello, M. Guarini, M. McShane, & B. Scasselatti (Eds.), *Proceedings of the 36th Annual Conference of the Cognitive Science Society* (pp. 2657–2662). Cognitive Science Society. Austin, TX. [https://escholarship.org/uc/item/66x226jt](https://escholarship.org/uc/item/66x226jt)

- Moscoso del Prado Martín, F. (2017). Vocabulary, grammar, sex, and aging. *Cognitive Science*, **41**, 950–975. [https://doi.org/10.1111/cogs.12367](https://doi.org/10.1111/cogs.12367)

- Moscoso del Prado Martín, F. (2025) Measuring Grammatical Diversity from Small Corpora: Derivational Entropy Rates, Mean Length of Utterances, and Annotation Invariance. *Computational Linguistics*, 2025. [https://doi.org/10.1162/coli.a.15](https://doi.org/10.1162/coli.a.15)


---

## Author

Fermin Moscoso del Prado Martin (fm611@cst.cam.ac.uk)
