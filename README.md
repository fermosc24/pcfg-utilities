
# PCFG Utilities

PCFG Utilities is a Python package providing tools for analysis of **Probabilistic Context-Free Grammars (PCFGs)**, including characteristic matrices, derivational entropy, expected yields, and grammar information metrics.

---

## Features

- **Characteristic Matrix**: Compute the expected number of direct nonterminal expansions.
- **SITE (Smoothed Induced Treebank Entropy)**: Estimate the symbolic entropy from a collection of NLTK Trees.
- **Derivational Entropy**: Calculate per-nonterminal entropy using PCFG rule probabilities.
- **Mean Terminal Yield**: Compute the expected number of terminals generated by each nonterminal.
- **Simple integration with NLTK grammars and trees**

---

## Requirements

- [nltk](https://www.nltk.org/)
- numpy
- [entropy_estimators](https://github.com/fermosc24/entropy-estimators) (must be installed manually, see below)

---

## Installation

### 1. Install Required Dependency

Before installing this package, install `entropy_estimators` from GitHub:

```bash
pip install git+https://github.com/fermosc24/entropy-estimators.git
```

### 2. Install pcfg_utilities

Clone this repository and install with pip:

```bash
git clone https://github.com/fermosc24/pcfg-utilities.git
cd pcfg-utilities
pip install .
```

---

## Usage

### **Characteristic Matrix**

```python
from pcfg_utilities.pcfg_utilities import characteristic_matrix
from nltk.grammar import PCFG

grammar = PCFG.fromstring("""
   S -> NP VP [1.0]
   NP -> 'John' [0.5] | 'Mary' [0.5]
   VP -> V NP [1.0]
   V -> 'sees' [1.0]
""")

M, nonterminals = characteristic_matrix(grammar)
print("Characteristic Matrix:\n", M)
print("Nonterminals:", nonterminals)
```
**Output:**
```
Characteristic Matrix:
[[0. 1. 1. 0.]
 [0. 0. 0. 0.]
 [0. 1. 0. 1.]
 [0. 0. 0. 0.]]
Nonterminals: [S, NP, VP, V]
```

---

### **SITE (Smoothed Induced Treebank Entropy)**

```python
from pcfg_utilities.pcfg_utilities import SITE
from nltk import Tree
from nltk.grammar import PCFG

grammar = PCFG.fromstring("""
   S -> NP VP [1.0]
   NP -> 'John' [0.5] | 'Mary' [0.5]
   VP -> V NP [1.0]
   V -> 'sees' [1.0]
""")

from pcfg_utilities.pcfg_utilities import sample_n_trees
trees = sample_n_trees(grammar, 100)

site = SITE(trees, method="MLE")
for nt, value in site.items():
    print(f"{nt}: {value:.3f}")
```
**Expected output:**
```
S: 2.000
NP: 1.000
VP: 1.000
V: 0.000
```

---

### **Derivational Entropy**

```python
from pcfg_utilities.pcfg_utilities import derivational_entropy

entropy = derivational_entropy(grammar)
for nt, value in entropy.items():
    print(f"{nt}: {value:.3f}")
```
**Output:**
```
S: 0.000
NP: 1.000
VP: 0.000
V: 0.000
```

---

### **Mean Terminal Yield Length**

```python
from pcfg_utilities.pcfg_utilities import mean_length

lengths = mean_length(grammar)
for nt, value in lengths.items():
    print(f"{nt}: {value:.3f}")
```
**Output:**
```
S: 3.000
NP: 1.000
VP: 2.000
V: 1.000
```

---

## Function Reference

### characteristic_matrix(pcfg)
> Computes the characteristic matrix for a given PCFG.
>
> - **Args**:  
>   `pcfg` (`nltk.grammar.PCFG`): The input grammar.
> - **Returns**:  
>   `(M, nonterminals)`:  
>     - `M` (np.ndarray): Characteristic matrix.  
>     - `nonterminals` (list): List of nonterminals (order for M's rows/columns).

---

### SITE(trees, method="MLE")
> Estimates **Smoothed Induced Treebank Entropy (SITE)** from a collection of NLTK trees.
>
> - **Args**:  
>   `trees` (list of `nltk.Tree`): List of parsed sentences.  
>   `method` (str): Entropy estimator method (see `entropy_estimators`).
> - **Returns**:  
>   `dict`: `{Nonterminal: SITE value}`

---

### derivational_entropy(pcfg)
> Computes the expected derivational entropy for each nonterminal of a PCFG using rule probabilities.
>
> - **Args**:  
>   `pcfg` (`nltk.grammar.PCFG`): The input grammar.
> - **Returns**:  
>   `dict`: `{Nonterminal: entropy}`

---

### mean_length(pcfg)
> Computes the mean terminal yield length for each nonterminal.
>
> - **Args**:  
>   `pcfg` (`nltk.grammar.PCFG`): The input grammar.
> - **Returns**:  
>   `dict`: `{Nonterminal: expected yield length}`

---

### sample_n_trees(pcfg, n)
> Randomly samples `n` trees from a PCFG. Useful for generating training data or testing.
>
> - **Args**:  
>   `pcfg` (`nltk.grammar.PCFG`): The grammar to sample from.  
>   `n` (int): Number of samples.
> - **Returns**:  
>   `list` of `nltk.Tree`: Sampled trees.

---

## Testing

To run the included tests:

```bash
python -m unittest discover tests
```

---

## Contributing

Contributions and suggestions are welcome! Please file an issue or submit a pull request on GitHub.

---

## License

MIT License (see [LICENSE](LICENSE))

---

## Citation

If you use this library in academic work, please cite the repository and the paper:

Moscoso del Prado Martín, Fermín; Measuring Grammatical Diversity from Small Corpora: Derivational Entropy Rates, Mean Length of Utterances, and Annotation Invariance. *Computational Linguistics* 2025; doi: [https://doi.org/10.1162/coli.a.15](https://doi.org/10.1162/coli.a.15)

---

## Author

Fermin Moscoso del Prado Martin (fm611@cst.cam.ac.uk)
